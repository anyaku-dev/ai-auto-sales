import { NextResponse } from 'next/server';
import OpenAI from 'openai';

export const maxDuration = 60;

const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

export async function POST(req: Request) {
  try {
    const body = await req.json();
    const { mode, inputs, senderInfo, currentText, refineInstruction } = body;

    let systemPrompt = "";
    let userPrompt = "";

    // 署名情報の構築
    const signatureBlock = senderInfo ? `
--------------------------------------------------
${senderInfo.company || '株式会社[会社名]'}
${senderInfo.department ? senderInfo.department + ' ' : ''}${senderInfo.name || '[氏名]'}
${senderInfo.url ? 'URL: ' + senderInfo.url : ''}
--------------------------------------------------
    ` : `
--------------------------------------------------
[あなたの会社名]
[あなたの氏名]
[URL]
--------------------------------------------------
    `;

    // ★★★ プロの書き味（Few-Shot Examples） ★★★
    const bestExamples = `
【参考にするべき「成功する問い合わせフォーム営業」の5つの型】
以下の5つのパターンは、売り込み感を消し、相手に「話を聞いてみたい」と思わせることに成功している事例です。これらを参考に、商材に合わせて最適なトーンと構成を選択・応用してください。

パターンA：【共感・シナジー型】（相手のビジョンや取り組みへの称賛から入る）
冒頭：「貴社の公式サイトにて、〇〇への取り組み（または理念）を拝見し、その姿勢に大変感銘を受け、ご連絡いたしました。株式会社〇〇の〇〇と申します。」
展開：「私どもも〇〇の領域で、〇〇という価値を追求しております。貴社の〇〇という強みと、弊社の〇〇技術を掛け合わせることで、これまでにない〇〇が実現できるのではないかと勝手ながら想像しております。」
結び：「もしよろしければ、貴社の今後の展望についてお聞かせいただく機会を頂戴できないでしょうか。」

パターンB：【課題解決・インサイト型】（業界共通の悩みに対する鋭い指摘）
冒頭：「〇〇業界における〇〇の課題解決を支援しております、株式会社〇〇の〇〇と申します。突然のご連絡にて恐縮です。」
展開：「多くの企業様が〇〇に苦慮される中、従来の〇〇ではなく、全く新しい『〇〇』というアプローチが成果を上げ始めています。貴社の事業におかれましても、この手法が〇〇の改善にお役に立てる可能性がございます。」
結び：「具体的な事例をまとめた資料がございます。まずは貴社の課題感に合うかご確認いただきたく、送付のお許可をいただけないでしょうか。」

パターンC：【シンプル・直球型】（多忙な決裁者に向けた、端的な価値提示）
冒頭：「株式会社〇〇の〇〇と申します。貴社の事業成長における『〇〇』の工程を、弊社の技術で効率化できる可能性を感じ、ご連絡いたしました。」
展開：「弊社は〇〇に特化したツールを提供しており、平均して〇〇%のコスト削減を実現しております。貴社の〇〇事業においても、同等のインパクトが出せると考えております。」
結び：「詳細なシミュレーションをお持ちしたいのですが、15分ほどオンラインで情報交換のお時間をいただけないでしょうか。」

パターンD：【第三者権威型】（導入実績やトレンドをさりげなく提示）
冒頭：「株式会社〇〇の〇〇です。現在、〇〇業界のトップランナー企業様の間で、〇〇という手法がスタンダードになりつつあることをご存知でしょうか。」
展開：「弊社はその先駆けとして、〇〇様や〇〇様をはじめとする企業様をご支援しております。貴社の先進的な取り組みを拝見するに、弊社のノウハウがお役に立てるフェーズにあると確信いたしました。」
結び：「業界の最新動向を含め、一度ディスカッションさせていただければ幸いです。」

パターンE：【招待・限定型】（営業ではなく「特別な案内」という体裁）
冒頭：「貴社の〇〇リリースを拝見いたしました、株式会社〇〇の〇〇です。この度、貴社のような〇〇企業様に限定して、新しいご提案の機会を設けております。」
展開：「一般公開前の情報にはなりますが、〇〇を劇的に改善するβ版のモニターとして、貴社のご意見をいただけないかと考えております。」
結び：「ご興味をお持ちいただけましたら、詳細をご説明にあがります。ご返信をお待ちしております。」
    `;

    // 共通のペルソナ・ルール定義
    const basePersona = `
    あなたはBtoB問い合わせフォーム営業の最高峰コピーライターです。
    上記の「成功する5つの型」のニュアンスを完璧に理解し、入力された商材情報に合わせて、最も効果的と思われる文章を作成してください。

    【絶対厳守ルール】
    1. **件名は出力しないこと**。本文のみを出力してください。
    2. **冒頭の挨拶**は必ず入れてください。「株式会社[自社名]の[氏名]と申します。」のように、名乗ることから始めてください。
    3. **変数（company_nameなど）は禁止**。特定の企業名が入らなくても自然に通じる文章にしてください（例：「貴社」「貴社の事業」）。
    4. **売り込まない**。「買ってください」ではなく「情報交換しませんか」「役に立つか判断してほしい」というスタンス。
    5. **末尾の署名**。以下の署名情報をそのまま末尾に使用してください。
    ${signatureBlock}

    【禁止ワード】
    ×「突然のご連絡失礼いたします」（陳腐なのでNG）
    ×「営業のご連絡です」（読まれないのでNG）
    ×「いかがでしょうか」（押し付けがましい場合がある。「幸いです」等に変換）
    × 実績の数字自慢（嫌味にならない程度に、さらっと事実だけ伝える）
    `;

    if (mode === 'draft') {
      systemPrompt = basePersona;
      userPrompt = `
      以下の情報をもとに、上記の「成功する5つの型」のいずれか（または融合）をベースにして、最高品質の営業メール本文を作成してください。

      【入力情報】
      ・商材名：${inputs.productName}
      ・商材URL：${inputs.productUrl}
      ・狙う企業タイプ：${inputs.targetType}
      ・一番届けたい価値：${inputs.coreValue}
      ・最終ゴール：${inputs.goal}

      ${bestExamples}
      `;

    } else if (mode === 'refine') {
      systemPrompt = `
      ${basePersona}
      あなたは優秀な編集者です。
      既存の文章の良さを活かしつつ、ユーザーの修正指示に従ってリライトしてください。
      署名は崩さないでください。
      `;

      userPrompt = `
      【現在の文章】:
      ${currentText}

      【修正指示】:
      ${refineInstruction}
      
      修正後の全文を出力してください。
      `;
    }

    const completion = await openai.chat.completions.create({
      model: "gpt-4o-mini",
      messages: [
        { role: "system", content: systemPrompt },
        { role: "user", content: userPrompt }
      ],
      temperature: 0.7, 
    });

    const resultText = completion.choices[0].message.content || '';
    return NextResponse.json({ resultText });

  } catch (e: any) {
    console.error("AI Rewrite Error:", e);
    return NextResponse.json({ error: e.message }, { status: 500 });
  }
}